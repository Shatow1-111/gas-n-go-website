<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas-n-Go Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8 pb-6 border-b border-slate-800">
            <div>
                <h1 class="text-3xl font-black text-indigo-400 italic uppercase">GAS-N-GO</h1>
                <nav id="main-nav" class="hidden mt-4 flex gap-6">
                    <button id="nav-apply" onclick="showPage('apply-form')" class="text-xs font-bold uppercase tracking-widest hover:text-indigo-400 transition">Apply</button>
                    <button id="nav-log" onclick="showPage('sales')" class="hidden text-xs font-bold uppercase tracking-widest hover:text-indigo-400 transition">Log Sale</button>
                    <button id="nav-history" onclick="fetchHistory()" class="hidden text-xs font-bold uppercase tracking-widest hover:text-indigo-400 transition">History</button>
                    <button id="nav-leader" onclick="showLeaderboard()" class="hidden text-xs font-bold uppercase tracking-widest hover:text-indigo-400 transition">Leaderboard</button>
                    <button id="nav-apps" onclick="showPage('apps')" class="hidden text-xs font-bold uppercase tracking-widest hover:text-indigo-400 transition">Loyalty List</button>
                </nav>
            </div>
            <div id="auth-section"></div>
        </header>

        <main id="content">
            <div class="flex justify-center py-20"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div></div>
        </main>
    </div>

    <script>
        const WORKER_URL = "https://gas-n-go-website.gruskinkolten.workers.dev";

        async function init() {
            try {
                const res = await fetch(`${WORKER_URL}/applications`, { credentials: 'include' });
                if (res.status === 401) return showLoggedOutUI();
                
                document.getElementById('main-nav').classList.remove('hidden');
                document.getElementById('auth-section').innerHTML = `<button onclick="location.href='${WORKER_URL}/logout'" class="bg-slate-800 px-4 py-2 rounded text-xs font-bold transition uppercase">Logout</button>`;
                
                if (res.ok) { // ADMIN
                    ['nav-log','nav-history','nav-leader','nav-apps'].forEach(id => document.getElementById(id).classList.remove('hidden'));
                    const data = await res.json();
                    window.apps = data.documents || [];
                    showPage('apps');
                } else { // EMPLOYEE OR USER
                    // Check if employee by trying to hit log-sale (or just showing log)
                    document.getElementById('nav-log').classList.remove('hidden');
                    showPage('apply-form');
                }
            } catch (err) { document.getElementById('content').innerHTML = "Error."; }
        }

        async function fetchHistory() {
            const res = await fetch(`${WORKER_URL}/sales-history`, { credentials: 'include' });
            if (res.ok) {
                const data = await res.json();
                window.allSales = data.documents || [];
                showPage('history');
            }
        }

        function showLeaderboard() {
            if (!window.allSales) return fetchHistory().then(showLeaderboard);
            const counts = {};
            window.allSales.forEach(s => {
                const name = s.fields.employee.stringValue;
                counts[name] = (counts[name] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            
            let rows = sorted.map(([name, count], i) => `
                <tr class="border-b border-slate-800">
                    <td class="p-4 font-black text-indigo-400">#${i+1}</td>
                    <td class="p-4 font-bold">${name}</td>
                    <td class="p-4 text-green-400 font-bold">${count} Sales</td>
                </tr>`).join('');
            
            document.getElementById('content').innerHTML = `
                <h2 class="text-2xl font-black mb-6 uppercase italic">Employee Leaderboard</h2>
                <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                    <table class="w-full text-left">${rows || '<tr><td class="p-10 text-center">No sales data.</td></tr>'}</table>
                </div>`;
        }

        function showPage(page) {
            const content = document.getElementById('content');
            if (page === 'apply-form') {
                content.innerHTML = `
                <div class="max-w-md mx-auto bg-slate-800 p-8 rounded-3xl border border-slate-700">
                    <h2 class="text-2xl font-black mb-6 text-indigo-400 uppercase italic">Join Loyalty Program</h2>
                    <textarea id="apply-msg" placeholder="Tell us why you're joining..." class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl mb-6 h-32 outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <button onclick="submitApply()" id="apply-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-xl font-black uppercase transition">Submit Application</button>
                </div>`;
            } else if (page === 'sales') {
                content.innerHTML = `<div class="max-w-md mx-auto bg-slate-800 p-8 rounded-3xl border border-slate-700 text-center"><h2 class="text-2xl font-black mb-6 text-green-400 uppercase italic">Log Transaction</h2><input id="sale-customer" placeholder="CUSTOMER NAME" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl mb-4 outline-none uppercase font-bold text-sm"><input id="sale-item" placeholder="ITEM" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl mb-6 outline-none uppercase font-bold text-sm"><button onclick="logSale()" id="sale-btn" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-black uppercase transition">Log Purchase</button></div>`;
            } else if (page === 'apps') {
                let rows = window.apps.map(app => {
                    const id = app.name.split('/').pop();
                    return `<tr class="border-b border-slate-800"><td class="p-4 font-bold text-indigo-300">${app.fields.username.stringValue}</td><td class="p-4 text-slate-400">${app.fields.message.stringValue}</td><td class="p-4 text-right"><button onclick="deleteApp('${id}')" class="text-xs text-red-400">REMOVE</button></td></tr>`;
                }).join('');
                content.innerHTML = `<h2 class="text-2xl font-black mb-6 uppercase italic">Loyalty List</h2><div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden"><table class="w-full text-left">${rows || '<tr><td class="p-10 text-center">None</td></tr>'}</table></div>`;
            } else if (page === 'history') {
                content.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black uppercase italic">History</h2><input type="text" onkeyup="filterHistory()" id="history-search" placeholder="Search..." class="bg-slate-800 p-2 rounded border border-slate-700 text-xs"></div><div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden"><table class="w-full text-left"><tbody id="history-body">${renderHistoryRows(window.allSales || [])}</tbody></table></div>`;
            }
        }

        async function submitApply() {
            const message = document.getElementById('apply-msg').value;
            if (!message) return alert("Enter a message!");
            const res = await fetch(`${WORKER_URL}/apply`, { method: 'POST', body: JSON.stringify({ message }), credentials: 'include' });
            if (res.ok) { alert("Applied successfully!"); showPage('apply-form'); }
        }

        async function logSale() {
            const customer = document.getElementById('sale-customer').value;
            const item = document.getElementById('sale-item').value;
            const res = await fetch(`${WORKER_URL}/log-sale`, { method: 'POST', body: JSON.stringify({ customer, item }), credentials: 'include' });
            if (res.ok) { alert("Logged!"); } else { alert("Permission Denied."); }
        }

        function renderHistoryRows(sales) {
            return sales.map(s => `<tr class="border-b border-slate-800 text-sm"><td class="p-4 font-bold text-indigo-400">${s.fields.employee.stringValue}</td><td class="p-4 text-green-400">${s.fields.customer.stringValue}</td><td class="p-4">${s.fields.item.stringValue}</td></tr>`).join('');
        }

        function showLoggedOutUI() {
            document.getElementById('content').innerHTML = `<div class="text-center py-20"><button onclick="location.href='${WORKER_URL}/login'" class="bg-indigo-600 px-10 py-4 rounded-full font-black text-xl transition">LOGIN WITH DISCORD</button></div>`;
        }

        window.onload = init;
    </script>
</body>
</html>
